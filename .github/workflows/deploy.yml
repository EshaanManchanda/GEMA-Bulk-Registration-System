name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      branch:
        description: 'Branch to deploy (e.g., main, develop, feature/xyz)'
        required: true
        default: 'main'
        type: string

# Restrict permissions to minimum required
permissions:
  contents: read

# Prevent concurrent deployments
concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  # Validate inputs before deployment
  validate:
    name: Validate Inputs
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      branch: ${{ steps.validate-branch.outputs.branch }}
    steps:
      - name: Validate branch name
        id: validate-branch
        run: |
          BRANCH="${{ inputs.branch }}"
          # Strict validation: only allow alphanumeric, hyphens, underscores, slashes
          if [[ ! "$BRANCH" =~ ^[a-zA-Z0-9/_-]+$ ]]; then
            echo "::error::Invalid branch name. Only alphanumeric characters, hyphens, underscores, and slashes allowed."
            exit 1
          fi
          # Prevent path traversal
          if [[ "$BRANCH" == *".."* ]]; then
            echo "::error::Invalid branch name. Path traversal not allowed."
            exit 1
          fi
          # Max length check
          if [[ ${#BRANCH} -gt 100 ]]; then
            echo "::error::Branch name too long. Maximum 100 characters."
            exit 1
          fi
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Branch validated: $BRANCH"

  deploy-production:
    name: Deploy to Production
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: inputs.environment == 'production'
    environment:
      name: production
      url: https://your-domain.com
    steps:
      - name: Deploy to Production VPS
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        env:
          DEPLOY_BRANCH: ${{ needs.validate.outputs.branch }}
        with:
          host: ${{ secrets.PROD_VPS_HOST }}
          username: ${{ secrets.PROD_VPS_USER }}
          key: ${{ secrets.PROD_VPS_SSH_KEY }}
          envs: DEPLOY_BRANCH
          script_stop: true
          script: |
            set -euo pipefail
            cd /var/www/gema || exit 1
            git fetch origin "$DEPLOY_BRANCH" --depth=1
            git reset --hard "origin/$DEPLOY_BRANCH"
            cd server && npm ci --production --ignore-scripts && npm rebuild
            pm2 reload ecosystem.config.js --env production
            cd ../client && npm ci --ignore-scripts && npm rebuild && npm run build
            sudo systemctl reload nginx
            echo "Production deployment of $DEPLOY_BRANCH complete at $(date -u)"

  deploy-staging:
    name: Deploy to Staging
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.your-domain.com
    steps:
      - name: Deploy to Staging VPS
        uses: appleboy/ssh-action@029f5b4aeeeb58fdfe1410a5d17f967dacf36262 # v1.0.3
        env:
          DEPLOY_BRANCH: ${{ needs.validate.outputs.branch }}
        with:
          host: ${{ secrets.STAGING_VPS_HOST }}
          username: ${{ secrets.STAGING_VPS_USER }}
          key: ${{ secrets.STAGING_VPS_SSH_KEY }}
          envs: DEPLOY_BRANCH
          script_stop: true
          script: |
            set -euo pipefail
            cd /var/www/gema-staging || exit 1
            git fetch origin "$DEPLOY_BRANCH" --depth=1
            git reset --hard "origin/$DEPLOY_BRANCH"
            cd server && npm ci --production --ignore-scripts && npm rebuild
            pm2 reload ecosystem.config.js --env staging
            cd ../client && npm ci --ignore-scripts && npm rebuild && npm run build
            sudo systemctl reload nginx
            echo "Staging deployment of $DEPLOY_BRANCH complete at $(date -u)"

  summary:
    name: Deployment Summary
    needs: [validate, deploy-production, deploy-staging]
    runs-on: ubuntu-latest
    if: always() && (needs.deploy-production.result == 'success' || needs.deploy-staging.result == 'success')
    steps:
      - name: Write Summary
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          DEPLOY_BRANCH: ${{ needs.validate.outputs.branch }}
          DEPLOY_ACTOR: ${{ github.actor }}
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** $DEPLOY_ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** $DEPLOY_BRANCH" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** $DEPLOY_ACTOR" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Success" >> $GITHUB_STEP_SUMMARY
